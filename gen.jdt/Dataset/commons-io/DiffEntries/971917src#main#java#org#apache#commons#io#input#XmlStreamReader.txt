Previous File: OUTPUT/commons-io/prevFiles/prev_971917src#main#java#org#apache#commons#io#input#XmlStreamReader.java
Revised File: OUTPUT/commons-io/revFiles/971917src#main#java#org#apache#commons#io#input#XmlStreamReader.java
DiffEntry: @@ -203,4 +203,6 @@
         this.defaultEncoding = defaultEncoding;
-        this.encoding = doRawStream(is, lenient);
-        this.reader = new InputStreamReader(is, encoding);
+        BOMInputStream bom = new BOMInputStream(new BufferedInputStream(is, BUFFER_SIZE), false, BOMS);
+        BOMInputStream pis = new BOMInputStream(bom, true, XML_GUESS_BYTES);
+        this.encoding = doRawStream(bom, pis, lenient);
+        this.reader = new InputStreamReader(pis, encoding);
     }

@@ -252,8 +254,10 @@
         InputStream is = conn.getInputStream();
+        BOMInputStream bom = new BOMInputStream(new BufferedInputStream(is, BUFFER_SIZE), false, BOMS);
+        BOMInputStream pis = new BOMInputStream(bom, true, XML_GUESS_BYTES);
         if (conn instanceof HttpURLConnection || contentType != null) {
-            this.encoding = doHttpStream(is, contentType, lenient);
+            this.encoding = doHttpStream(bom, pis, contentType, lenient);
         } else {
-            this.encoding = doRawStream(is, lenient);
+            this.encoding = doRawStream(bom, pis, lenient);
         }
-        this.reader = new InputStreamReader(is, encoding);
+        this.reader = new InputStreamReader(pis, encoding);
     }

@@ -319,4 +323,6 @@
         this.defaultEncoding = defaultEncoding;
-        this.encoding = doHttpStream(is, httpContentType, lenient);
-        this.reader = new InputStreamReader(is, encoding);
+        BOMInputStream bom = new BOMInputStream(new BufferedInputStream(is, BUFFER_SIZE), false, BOMS);
+        BOMInputStream pis = new BOMInputStream(bom, true, XML_GUESS_BYTES);
+        this.encoding = doHttpStream(bom, pis, httpContentType, lenient);
+        this.reader = new InputStreamReader(pis, encoding);
     }

@@ -396,3 +402,4 @@
      *
-     * @param is InputStream to create the reader from.
+     * @param bom BOMInputStream to detect byte order marks
+     * @param pis BOMInputStream to guess XML encoding
      * @param lenient indicates if the charset encoding detection should be

@@ -402,6 +409,4 @@
      */
-    private String doRawStream(InputStream is, boolean lenient)
+    private String doRawStream(BOMInputStream bom, BOMInputStream pis, boolean lenient)
             throws IOException {
-        BOMInputStream bom = new BOMInputStream(new BufferedInputStream(is, BUFFER_SIZE), false, BOMS);
-        BOMInputStream pis = new BOMInputStream(bom, true, XML_GUESS_BYTES);
         String bomEnc      = bom.getBOMCharsetName();

@@ -413,3 +418,3 @@
             if (lenient) {
-                return doLenientDetection(null, is, ex);
+                return doLenientDetection(null, ex);
             } else {

@@ -423,3 +428,4 @@
      *
-     * @param is InputStream to create the reader from.
+     * @param bom BOMInputStream to detect byte order marks
+     * @param pis BOMInputStream to guess XML encoding
      * @param httpContentType The HTTP content type

@@ -430,6 +436,4 @@
      */
-    private String doHttpStream(InputStream is, String httpContentType,
+    private String doHttpStream(BOMInputStream bom, BOMInputStream pis, String httpContentType,
             boolean lenient) throws IOException {
-        BOMInputStream bom = new BOMInputStream(new BufferedInputStream(is, BUFFER_SIZE), false, BOMS);
-        BOMInputStream pis = new BOMInputStream(bom, true, XML_GUESS_BYTES);
         String bomEnc      = bom.getBOMCharsetName();

@@ -442,3 +446,3 @@
             if (lenient) {
-                return doLenientDetection(httpContentType, is, ex);
+                return doLenientDetection(httpContentType, ex);
             } else {

@@ -454,3 +458,2 @@
      *        the charset encoding.
-     * @param is the unconsumed InputStream
      * @param ex The thrown exception

@@ -459,3 +462,3 @@
      */
-    private String doLenientDetection(String httpContentType, InputStream is,
+    private String doLenientDetection(String httpContentType,
             XmlStreamReaderException ex) throws IOException {

